--!strict
-- Lasso Market (Torn + Western only) with draggable panel & minimize-to-icon

local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LP = Players.LocalPlayer

-- =========================
-- ====== DATA ============
-- =========================
type LassoItem = { id: string, name: string, price: number }
local Catalog: {LassoItem} = {
    { id = "TornLasso",    name = "TornLasso",    price = 50 },
    { id = "WesternLasso", name = "WesternLasso", price = 90 },
}
local Order: { [string]: number } = {}
for _, it in ipairs(Catalog) do Order[it.id] = 0 end

-- trigger stub
_G.TriggerLassoPurchase = function()
    print("[LassoMarket] Trigger called. Queue:")
    for _, it in ipairs(Catalog) do
        local q = Order[it.id]
        if q > 0 then
            print(("- %s x%d @ %d = %d"):format(it.name, q, it.price, it.price*q))
        end
    end
end

-- =========================
-- ====== UI ============
-- =========================
local PlayerGui = LP:WaitForChild("PlayerGui")

local Screen = Instance.new("ScreenGui")
Screen.Name = "LassoMarketUI"
Screen.ResetOnSpawn = false
Screen.IgnoreGuiInset = true
Screen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
Screen.Parent = PlayerGui

-- main panel
local Panel = Instance.new("Frame")
Panel.Name = "Panel"
Panel.Position = UDim2.new(0, 24, 0, 80)
Panel.Size = UDim2.new(0, 360, 0, 200)
Panel.BackgroundColor3 = Color3.fromRGB(22,22,22)
Panel.BackgroundTransparency = 0.1
Panel.BorderSizePixel = 0
Panel.Active = true
Panel.Parent = Screen

-- drag
do
    local dragging, dragStart, startPos = false, nil, nil
    Panel.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Panel.Position
        end
    end)
    Panel.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
    UIS.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement and dragStart and startPos then
            local delta = input.Position - dragStart
            Panel.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- title
local title = Instance.new("TextLabel")
title.BackgroundTransparency = 1
title.Position = UDim2.new(0, 10, 0, 6)
title.Size = UDim2.new(1, -40, 0, 20)
title.Font = Enum.Font.Code
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextColor3 = Color3.fromRGB(220,255,220)
title.Text = "Lasso Market (queue)"
title.Parent = Panel

-- minimize button
local MinBtn = Instance.new("TextButton")
MinBtn.Position = UDim2.new(1, -28, 0, 4)
MinBtn.Size = UDim2.new(0, 24, 0, 24)
MinBtn.Text = "â€“"
MinBtn.TextScaled = true
MinBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
MinBtn.BorderSizePixel = 0
MinBtn.Parent = Panel

-- list area
local List = Instance.new("Frame")
List.Name = "List"
List.Position = UDim2.new(0, 10, 0, 32)
List.Size = UDim2.new(1, -20, 1, -50)
List.BackgroundTransparency = 1
List.Parent = Panel

-- row template
local function makeRow(it: LassoItem, y: number)
    local r = Instance.new("Frame")
    r.Size = UDim2.new(1, 0, 0, 28)
    r.Position = UDim2.new(0, 0, 0, y)
    r.BackgroundTransparency = 1
    r.Parent = List

    local nameL = Instance.new("TextLabel")
    nameL.BackgroundTransparency = 1
    nameL.Position = UDim2.new(0,0,0,4)
    nameL.Size = UDim2.new(0.45,0,1,-8)
    nameL.Font = Enum.Font.Code
    nameL.TextSize = 14
    nameL.TextColor3 = Color3.fromRGB(235,235,235)
    nameL.TextXAlignment = Enum.TextXAlignment.Left
    nameL.Text = it.name
    nameL.Parent = r

    local priceL = nameL:Clone()
    priceL.Position = UDim2.new(0.45,0,0,4)
    priceL.Size = UDim2.new(0.15,0,1,-8)
    priceL.TextColor3 = Color3.fromRGB(200,220,255)
    priceL.Text = tostring(it.price)
    priceL.Parent = r

    local minus = Instance.new("TextButton")
    minus.Position = UDim2.new(0.65,0,0,2)
    minus.Size = UDim2.new(0,24,0,24)
    minus.Text = "â€“"
    minus.BackgroundColor3 = Color3.fromRGB(50,50,50)
    minus.BorderSizePixel = 0
    minus.Parent = r

    local qty = Instance.new("TextBox")
    qty.Position = UDim2.new(0.75,0,0,2)
    qty.Size = UDim2.new(0,40,0,24)
    qty.Text = tostring(Order[it.id])
    qty.ClearTextOnFocus = false
    qty.BackgroundColor3 = Color3.fromRGB(30,30,30)
    qty.TextColor3 = Color3.fromRGB(240,240,240)
    qty.BorderSizePixel = 0
    qty.Font = Enum.Font.Code
    qty.TextSize = 14
    qty.Parent = r

    local plus = minus:Clone()
    plus.Text = "+"
    plus.Position = UDim2.new(0.75,44,0,2)
    plus.Parent = r

    -- logic
    local function updateQty(n)
        if n < 0 then n = 0 end
        if n > 999 then n = 999 end
        Order[it.id] = n
        qty.Text = tostring(n)
    end

    minus.MouseButton1Click:Connect(function()
        updateQty(Order[it.id]-1)
    end)
    plus.MouseButton1Click:Connect(function()
        updateQty(Order[it.id]+1)
    end)
    qty.FocusLost:Connect(function()
        local n = tonumber(qty.Text) or 0
        updateQty(n)
    end)
end

for i,it in ipairs(Catalog) do
    makeRow(it,(i-1)*30)
end

-- total label
local Total = Instance.new("TextLabel")
Total.BackgroundTransparency = 1
Total.Position = UDim2.new(0, 10, 1, -20)
Total.Size = UDim2.new(1, -20, 0, 18)
Total.Font = Enum.Font.Code
Total.TextSize = 14
Total.TextColor3 = Color3.fromRGB(235,255,235)
Total.TextXAlignment = Enum.TextXAlignment.Left
Total.Text = "Queued total: n/a"
Total.Parent = Panel

-- update total loop
task.spawn(function()
    while true do
        task.wait(0.5)
        local sum = 0
        for _, it in ipairs(Catalog) do
            local q = Order[it.id]
            sum += it.price*q
        end
        Total.Text = "Queued total: "..tostring(sum)
    end
end)

-- small icon
local Icon = Instance.new("TextButton")
Icon.Name = "MiniIcon"
Icon.Size = UDim2.new(0,40,0,40)
Icon.Position = UDim2.new(0,24,0,80)
Icon.Text = "ðŸª¢" -- lasso emoji-like
Icon.Font = Enum.Font.SourceSansBold
Icon.TextSize = 24
Icon.BackgroundColor3 = Color3.fromRGB(35,35,35)
Icon.BorderSizePixel = 0
Icon.Visible = false
Icon.Parent = Screen

-- minimize / restore
MinBtn.MouseButton1Click:Connect(function()
    Panel.Visible = false
    Icon.Visible = true
    Icon.Position = Panel.Position -- dock where panel was
end)
Icon.MouseButton1Click:Connect(function()
    Panel.Visible = true
    Icon.Visible = false
end)

-- hotkey J toggle
UIS.InputBegan:Connect(function(input,gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.J then
        local v = not Panel.Visible and not Icon.Visible
        Panel.Visible = v
        Icon.Visible = not v
    end
end)

print("[LassoMarket] ready. J = toggle panel, â€“ = minimize to icon, click ðŸª¢ icon to restore.")
